<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore - 9Gaul</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h2><i class="fas fa-laugh-squint"></i> 9Gaul</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-home"></i> Beranda</a></li>
                    <li><a href="explore.html" class="active"><i class="fas fa-compass"></i> Explore</a></li>
                    <li><a href="groups.html"><i class="fas fa-users"></i> Grup</a></li>
                    <li class="separator"></li>
                    <li><a href="service-center.html"><i class="fas fa-headset"></i> Service Center</a></li>
                    <li><a href="donate.html"><i class="fas fa-heart"></i> Donasi</a></li>
                </ul>
            </nav>
            <div class="sidebar-profile">
                <a href="profile.html"><img src="https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P" alt="Profil Pengguna" id="sidebarUserAvatar"></a>
                <div class="profile-info">
                    <a href="profile.html"><strong id="sidebarUsername">Loading...</strong></a>
                    <span class="user-email" id="loggedInEmailSidebar">Loading...</span>
                </div>
                <a href="#" class="logout-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button class="back-button-mobile" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
                <h1>Explore</h1>
                <div class="header-actions">
                    <button class="profile-icon-mobile-header" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
                </div>
            </header>

            <div class="explore-search-bar">
                <input type="text" id="exploreSearchBarInput" placeholder="Cari konten, pengguna, atau grup...">
                <button id="exploreSearchButton"><i class="fas fa-search"></i></button>
            </div>

            <section class="explore-section" id="searchResultsSection" style="display: none;">
                <h2><i class="fas fa-search"></i> Hasil Pencarian</h2>
                <div id="searchResultsContainer" class="trending-posts-grid">
                    </div>
                <p id="noSearchResults" style="display: none; text-align: center; color: var(--sub-text-color);">Tidak ada hasil ditemukan.</p>
            </section>

            <section class="explore-section">
                <h2><i class="fas fa-fire"></i> Trending Postingan</h2>
                <div id="trendingPostsContainer" class="trending-posts-grid">
                    </div>
            </section>

            <section class="explore-section">
                <h2><i class="fas fa-user-plus"></i> Akun yang Mungkin Anda Suka</h2>
                <div id="suggestedAccountsContainer" class="suggested-accounts-grid">
                    </div>
            </section>

            <section class="explore-section">
                <h2><i class="fas fa-users"></i> Rekomendasi Grup</h2>
                <div id="recommendedGroupsContainer" class="recommended-groups-grid">
                    </div>
            </section>

        </main>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span class="nav-text">Beranda</span></a>
            <a href="explore.html" class="nav-item active"><i class="fas fa-compass"></i><span class="nav-text">Explore</span></a>
            <a href="groups.html" class="nav-item"><i class="fas fa-users"></i><span class="nav-text">Grup</span></a>
        </nav>
    </div>

    <script type="module">
        // Import Firebase modules dari firebase-config.js
        import { auth, signOut, onAuthStateChanged, db, collection, getDocs, query, orderBy, where, doc, getDoc } from './firebase-config.js';

        let currentUserId = null; // Untuk menyimpan UID pengguna yang sedang login

        document.addEventListener('DOMContentLoaded', async () => {
            // Cek status autentikasi Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Set UID pengguna yang sedang login
                    console.log("User logged in:", user.uid);
                    await loadUserProfileSidebar(user.uid); // Muat data profil untuk sidebar
                    await loadTrendingPosts();
                    await loadSuggestedAccounts(user.uid); // Pass UID untuk filter akun sendiri
                    await loadRecommendedGroups();
                } else {
                    console.log("No user logged in. Redirecting to index.html");
                    window.location.href = 'index.html'; // Redirect jika belum login
                }
            });

            // Fungsi untuk memuat profil pengguna dari Firestore untuk sidebar
            async function loadUserProfileSidebar(uid) {
                const userDocRef = doc(db, "users", uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        document.getElementById('sidebarUsername').textContent = userData.username || 'Pengguna 9Gaul';
                        document.getElementById('loggedInEmailSidebar').textContent = userData.email || auth.currentUser.email;
                        document.getElementById('sidebarUserAvatar').src = userData.avatarUrl || 'https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P';
                    } else {
                        console.warn("User profile not found in Firestore for UID:", uid);
                        // Fallback ke info dasar jika profil tidak ditemukan
                        document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                        document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                    }
                } catch (error) {
                    console.error("Error loading user profile:", error);
                    // Fallback jika terjadi error
                    document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                    document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                }
            }


            // Highlighting the active link
            const path = window.location.pathname.split('/').pop();
            document.querySelectorAll('.sidebar-nav a, .bottom-nav .nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === path) {
                    link.classList.add('active');
                }
            });

            // Event listener untuk tombol "Ikuti" dan "Gabung" (akan diperbarui nanti untuk Firebase)
            document.addEventListener('click', (event) => {
                if (event.target.classList.contains('follow-button')) {
                    // Implementasi Firebase untuk follow (akan dibahas nanti)
                    alert('Fungsi Ikuti akan terhubung dengan Firebase!');
                    event.target.textContent = 'Mengikuti';
                    event.target.disabled = true;
                    event.target.style.backgroundColor = '#4CAF50'; // Green
                } else if (event.target.classList.contains('join-button')) {
                    // Implementasi Firebase untuk join grup (akan dibahas nanti)
                    alert('Fungsi Gabung Grup akan terhubung dengan Firebase!');
                    event.target.textContent = 'Bergabung';
                    event.target.disabled = true;
                    event.target.style.backgroundColor = '#4CAF50'; // Green
                }
            });

            // Event listener untuk search bar
            const searchInput = document.getElementById('exploreSearchBarInput');
            const searchButton = document.getElementById('exploreSearchButton');
            searchButton.addEventListener('click', () => {
                performSearch(searchInput.value);
            });
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(searchInput.value);
                }
            });
        });

        // --- Fungsi Logout ---
        async function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                try {
                    await signOut(auth); // Menggunakan signOut dari Firebase Auth
                    // Hapus UID dari localStorage, jika masih digunakan untuk tujuan lain
                    localStorage.removeItem('lastLoggedInUserId');
                    window.location.href = 'index.html'; // Redirect ke halaman login
                } catch (error) {
                    console.error("Error logging out:", error);
                    alert('Gagal logout. Coba lagi.');
                }
            }
        }

        // Helper function to format timestamp (reused from dashboard)
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Beberapa waktu lalu';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.round(diffMs / (1000 * 60));
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

            if (diffMinutes < 1) return 'Baru saja';
            if (diffMinutes < 60) return `${diffMinutes} menit yang lalu`;
            if (diffHours < 24) return `${diffHours} jam yang lalu`;
            if (diffDays < 7) return `${diffDays} hari yang lalu`;
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }


        // --- Fungsi untuk Memuat Trending Postingan ---
        async function loadTrendingPosts() {
            const container = document.getElementById('trendingPostsContainer');
            container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Memuat trending postingan...</p>'; // Loading state
            try {
                // Ambil 4 postingan teratas berdasarkan 'votes' (upvotes - downvotes)
                const postsCollectionRef = collection(db, 'posts');
                const q = query(postsCollectionRef, orderBy('votes', 'desc'), limit(4)); // Limit 4 untuk demo
                const postsSnapshot = await getDocs(q);
                
                if (postsSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Tidak ada postingan trending.</p>';
                    return;
                }

                container.innerHTML = ''; // Kosongkan loading message
                postsSnapshot.forEach(doc => {
                    const post = doc.data();
                    const postItem = `
                        <div class="trending-item" data-post-id="${doc.id}">
                            <img src="${post.imageUrl || 'https://via.placeholder.com/150x100/333/FFFFFF?text=No+Image'}" alt="${post.caption || post.text}">
                            <p>${post.text ? (post.text.length > 50 ? post.text.substring(0, 47) + '...' : post.text) : 'Postingan tanpa teks'}</p>
                            <span class="trending-votes"><i class="fas fa-arrow-up"></i> ${post.votes || 0}</span>
                        </div>
                    `;
                    container.innerHTML += postItem;
                });
            } catch (error) {
                console.error("Error loading trending posts:", error);
                container.innerHTML = '<p style="text-align: center; color: var(--message-error-text); background-color: var(--message-error-bg); padding: 10px; border-radius: 5px;">Gagal memuat trending postingan.</p>';
            }
        }

        // --- Fungsi untuk Memuat Akun yang Disarankan ---
        async function loadSuggestedAccounts(currentUserId) {
            const container = document.getElementById('suggestedAccountsContainer');
            container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Memuat akun yang disarankan...</p>';
            try {
                const usersCollectionRef = collection(db, 'users');
                // Ambil beberapa pengguna, kecualikan diri sendiri
                const q = query(usersCollectionRef, orderBy('followers', 'desc'), limit(3)); // Ambil 3 akun teratas
                const usersSnapshot = await getDocs(q);

                if (usersSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Tidak ada akun yang disarankan.</p>';
                    return;
                }

                container.innerHTML = '';
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.uid === currentUserId) return; // Jangan tampilkan akun sendiri

                    const userItem = `
                        <div class="account-item" data-user-id="${user.uid}">
                            <img src="${user.avatarUrl || 'https://via.placeholder.com/60/cccccc/000000?text=U'}" alt="${user.username}">
                            <strong>${user.username || user.email.split('@')[0]}</strong>
                            <button class="follow-button">Ikuti</button>
                        </div>
                    `;
                    container.innerHTML += userItem;
                });
            } catch (error) {
                console.error("Error loading suggested accounts:", error);
                container.innerHTML = '<p style="text-align: center; color: var(--message-error-text); background-color: var(--message-error-bg); padding: 10px; border-radius: 5px;">Gagal memuat akun yang disarankan.</p>';
            }
        }

        // --- Fungsi untuk Memuat Rekomendasi Grup ---
        async function loadRecommendedGroups() {
            const container = document.getElementById('recommendedGroupsContainer');
            container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Memuat rekomendasi grup...</p>';
            try {
                const groupsCollectionRef = collection(db, 'groups');
                const q = query(groupsCollectionRef, orderBy('membersCount', 'desc'), limit(2)); // Misal 'membersCount'
                const groupsSnapshot = await getDocs(q);

                if (groupsSnapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Tidak ada grup yang direkomendasikan.</p>';
                    return;
                }

                container.innerHTML = '';
                groupsSnapshot.forEach(doc => {
                    const group = doc.data();
                    const groupItem = `
                        <div class="group-item" data-group-id="${doc.id}">
                            <img src="${group.iconUrl || 'https://via.placeholder.com/80/cccccc/000000?text=G'}" alt="${group.name}">
                            <div class="group-info">
                                <strong>${group.name}</strong>
                                <span>${(group.membersCount || 0).toLocaleString()} Anggota</span>
                            </div>
                            <button class="join-button">Gabung</button>
                        </div>
                    `;
                    container.innerHTML += groupItem;
                });
            } catch (error) {
                console.error("Error loading recommended groups:", error);
                container.innerHTML = '<p style="text-align: center; color: var(--message-error-text); background-color: var(--message-error-bg); padding: 10px; border-radius: 5px;">Gagal memuat rekomendasi grup.</p>';
            }
        }

        // --- Fungsi untuk Melakukan Pencarian ---
        async function performSearch(queryText) {
            const searchResultsSection = document.getElementById('searchResultsSection');
            const searchResultsContainer = document.getElementById('searchResultsContainer');
            const noSearchResults = document.getElementById('noSearchResults');

            searchResultsContainer.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Mencari...</p>';
            searchResultsSection.style.display = 'block';
            noSearchResults.style.display = 'none';

            if (!queryText.trim()) {
                searchResultsContainer.innerHTML = '';
                noSearchResults.textContent = 'Silakan masukkan kata kunci pencarian.';
                noSearchResults.style.display = 'block';
                return;
            }

            const lowerCaseQuery = queryText.toLowerCase();
            let resultsFound = 0;

            try {
                // Inisialisasi array untuk menyimpan hasil
                let allResultsHtml = '';

                // 1. Cari di koleksi 'posts'
                // Karena Firestore tidak mendukung pencarian teks penuh, kita akan melakukan pencarian "startsWith" sederhana
                // atau pertimbangkan integrasi dengan layanan pencarian pihak ketiga seperti Algolia/Elasticsearch untuk produksi.
                const postsQuery = query(collection(db, 'posts'), 
                                         where('text', '>=', queryText), // Mencari teks postingan
                                         where('text', '<=', queryText + '\uf8ff'),
                                         limit(5));
                const postSnapshot = await getDocs(postsQuery);
                postSnapshot.forEach(doc => {
                    const post = doc.data();
                    allResultsHtml += `
                        <div class="trending-item" data-post-id="${doc.id}">
                            <img src="${post.imageUrl || 'https://via.placeholder.com/150x100/333/FFFFFF?text=No+Image'}" alt="${post.caption || post.text}">
                            <p>${post.text ? (post.text.length > 50 ? post.text.substring(0, 47) + '...' : post.text) : 'Postingan tanpa teks'}</p>
                            <span class="trending-votes"><i class="fas fa-arrow-up"></i> ${post.votes || 0}</span>
                        </div>
                    `;
                    resultsFound++;
                });

                // 2. Cari di koleksi 'users'
                const usersQuery = query(collection(db, 'users'), 
                                        where('username', '>=', queryText), // Mencari berdasarkan username
                                        where('username', '<=', queryText + '\uf8ff'),
                                        limit(3));
                const userSnapshot = await getDocs(usersQuery);
                userSnapshot.forEach(doc => {
                    const user = doc.data();
                    allResultsHtml += `
                        <div class="account-item" data-user-id="${user.uid}">
                            <img src="${user.avatarUrl || 'https://via.placeholder.com/60/cccccc/000000?text=U'}" alt="${user.username}">
                            <strong>${user.username || user.email.split('@')[0]}</strong>
                            <button class="follow-button">Ikuti</button>
                        </div>
                    `;
                    resultsFound++;
                });

                // 3. Cari di koleksi 'groups'
                const groupsQuery = query(collection(db, 'groups'), 
                                          where('name', '>=', queryText), // Mencari berdasarkan nama grup
                                          where('name', '<=', queryText + '\uf8ff'),
                                          limit(3));
                const groupSnapshot = await getDocs(groupsQuery);
                groupSnapshot.forEach(doc => {
                    const group = doc.data();
                    allResultsHtml += `
                        <div class="group-item" data-group-id="${doc.id}">
                            <img src="${group.iconUrl || 'https://via.placeholder.com/80/cccccc/000000?text=G'}" alt="${group.name}">
                            <div class="group-info">
                                <strong>${group.name}</strong>
                                <span>${(group.membersCount || 0).toLocaleString()} Anggota</span>
                            </div>
                            <button class="join-button">Gabung</button>
                        </div>
                    `;
                    resultsFound++;
                });

                searchResultsContainer.innerHTML = allResultsHtml;

                if (resultsFound === 0) {
                    noSearchResults.textContent = `Tidak ada hasil untuk "${queryText}".`;
                    noSearchResults.style.display = 'block';
                }

            } catch (error) {
                console.error("Error performing search:", error);
                searchResultsContainer.innerHTML = '';
                noSearchResults.textContent = 'Terjadi kesalahan saat mencari.';
                noSearchResults.style.display = 'block';
            }
        }
    </script>
</body>
</html>
