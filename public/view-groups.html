<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nama Grup - 9Gaul</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h2><i class="fas fa-laugh-squint"></i> 9Gaul</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-home"></i> Beranda</a></li>
                    <li><a href="explore.html"><i class="fas fa-compass"></i> Explore</a></li>
                    <li><a href="groups.html" class="active"><i class="fas fa-users"></i> Grup</a></li>
                    <li class="separator"></li>
                    <li><a href="service-center.html"><i class="fas fa-headset"></i> Service Center</a></li>
                    <li><a href="donate.html"><i class="fas fa-heart"></i> Donasi</a></li>
                </ul>
            </nav>
            <div class="sidebar-profile">
                <a href="profile.html"><img src="https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P" alt="Profil Pengguna" id="sidebarUserAvatar"></a>
                <div class="profile-info">
                    <a href="profile.html"><strong id="sidebarUsername">Loading...</strong></a>
                    <span class="user-email" id="loggedInEmailSidebar">Loading...</span>
                </div>
                <a href="#" class="logout-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button class="back-button-mobile" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
                <h1><span id="groupNameHeader">Memuat...</span></h1>
                <div class="header-actions">
                    <button id="createPostButton" style="display: none;" onclick="navigateToCreatePost()"><i class="fas fa-plus"></i></button>
                    <button class="profile-icon-mobile-header" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
                </div>
            </header>

            <section class="group-detail-container" id="groupDetailContent">
                <p id="loadingMessage" style="text-align: center; color: var(--sub-text-color); margin-top: 50px;">Memuat data grup...</p>
                <p id="groupNotFoundMessage" class="message-error" style="display: none; text-align: center; margin-top: 50px;">Grup tidak ditemukan.</p>

                <div id="groupContentWrapper" style="display: none;">
                    <div class="group-hero">
                        <img id="groupBanner" src="https://via.placeholder.com/800x200/202020/61dafb?text=Banner+Grup" alt="Group Banner">
                        <div class="group-info-overlay">
                            <img id="groupAvatar" src="https://via.placeholder.com/100/FF5700/FFFFFF?text=G" alt="Group Avatar">
                            <div>
                                <h2 id="groupName"></h2>
                                <p id="groupMembers"></p>
                            </div>
                        </div>
                    </div>

                    <div class="group-actions">
                        <button id="joinLeaveButton" class="join-button">Memuat...</button>
                        <button class="share-button-group" onclick="alert('Fitur bagikan akan datang!')"><i class="fas fa-share-alt"></i> Bagikan</button>
                        <button class="more-options-group" onclick="alert('Fitur opsi lainnya akan datang!')"><i class="fas fa-ellipsis-h"></i></button>
                    </div>

                    <div class="group-description card-style">
                        <h3>Tentang Grup Ini</h3>
                        <p id="groupDescription"></p>
                    </div>

                    <div class="group-posts-section">
                        <h3>Postingan Grup</h3>
                        <div class="post-feed" id="groupPostsFeed">
                            <p style="text-align: center; color: var(--sub-text-color);">Memuat postingan grup...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span class="nav-text">Beranda</span></a>
            <a href="explore.html" class="nav-item"><i class="fas fa-compass"></i><span class="nav-text">Explore</span></a>
            <a href="groups.html" class="nav-item active"><i class="fas fa-users"></i><span class="nav-text">Grup</span></a>
        </nav>
    </div>

    <script type="module">
        // Import Firebase modules dari firebase-config.js
        import { auth, signOut, onAuthStateChanged, db, collection, getDoc, doc, updateDoc, arrayUnion, arrayRemove, query, where, orderBy, getDocs, limit } from './firebase-config.js';

        let currentUserId = null; // Untuk menyimpan UID pengguna yang sedang login
        let currentGroupId = null; // Untuk menyimpan ID grup yang sedang dilihat
        let groupData = null; // Untuk menyimpan data grup

        document.addEventListener('DOMContentLoaded', async () => {
            // Highlighting the active link
            const path = window.location.pathname.split('/').pop();
            document.querySelectorAll('.sidebar-nav a, .bottom-nav .nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === path) {
                    link.classList.add('active');
                }
            });

            // Get group ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentGroupId = urlParams.get('id');

            if (!currentGroupId) {
                displayGroupNotFound("ID Grup tidak ditemukan di URL.");
                return;
            }

            // Cek status autentikasi Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("User logged in:", user.uid);
                    await loadUserProfileSidebar(user.uid);
                    await loadGroupDetails(currentGroupId, user.uid);
                } else {
                    console.log("No user logged in. Redirecting to index.html");
                    window.location.href = 'index.html'; // Redirect jika belum login
                }
            });

            // Join/Leave button logic
            document.getElementById('joinLeaveButton').addEventListener('click', async () => {
                if (!currentUserId) {
                    alert('Anda harus login untuk bergabung dengan grup.');
                    return;
                }
                if (!groupData) {
                    alert('Data grup belum dimuat sepenuhnya. Coba lagi.');
                    return;
                }

                const button = document.getElementById('joinLeaveButton');
                button.disabled = true; // Disable button while processing

                try {
                    const groupDocRef = doc(db, 'groups', currentGroupId);
                    const userDocRef = doc(db, 'users', currentUserId);

                    const isMember = groupData.members && groupData.members.includes(currentUserId);

                    if (isMember) {
                        // Keluar dari grup
                        await updateDoc(groupDocRef, {
                            members: arrayRemove(currentUserId),
                            membersCount: (groupData.membersCount || 1) - 1
                        });
                        await updateDoc(userDocRef, {
                            joinedGroups: arrayRemove(currentGroupId)
                        });
                        button.textContent = 'Gabung';
                        button.classList.remove('active-join');
                        alert('Anda telah keluar dari grup.');
                    } else {
                        // Gabung grup
                        await updateDoc(groupDocRef, {
                            members: arrayUnion(currentUserId),
                            membersCount: (groupData.membersCount || 0) + 1
                        });
                        await updateDoc(userDocRef, {
                            joinedGroups: arrayUnion(currentGroupId)
                        });
                        button.textContent = 'Bergabung';
                        button.classList.add('active-join');
                        alert('Anda telah bergabung dengan grup!');
                    }
                    // Muat ulang detail grup untuk memperbarui jumlah anggota
                    await loadGroupDetails(currentGroupId, currentUserId);

                } catch (error) {
                    console.error("Error joining/leaving group:", error);
                    alert('Gagal memperbarui status grup. Coba lagi.');
                } finally {
                    button.disabled = false;
                }
            });

            // Dummy Vote Button Logic (will be enhanced for Firestore)
            document.getElementById('groupPostsFeed').addEventListener('click', async function(event) {
                const button = event.target.closest('.vote-button');
                if (!button) return;

                const postId = button.closest('.post-card').dataset.postId;
                if (!postId) {
                    console.error('Post ID not found for voting.');
                    return;
                }

                if (!currentUserId) {
                    alert('Anda harus login untuk memberikan vote.');
                    return;
                }

                const isUpvote = button.classList.contains('upvote');
                const voteCountSpan = button.parentElement.querySelector('.vote-count');
                let currentVotes = parseInt(voteCountSpan.textContent);

                // Disable buttons temporarily
                button.disabled = true;
                const otherButton = isUpvote ? button.nextElementSibling.nextElementSibling : button.previousElementSibling.previousElementSibling;
                if (otherButton) otherButton.disabled = true;

                try {
                    const postDocRef = doc(db, 'posts', postId);
                    const postDocSnap = await getDoc(postDocRef);
                    if (!postDocSnap.exists()) {
                        console.error('Post not found:', postId);
                        return;
                    }
                    let postData = postDocSnap.data();
                    let updatedVotes = postData.votes || 0;
                    let usersVoted = postData.usersVoted || {}; // { userId: voteType (-1/0/1) }

                    const userCurrentVote = usersVoted[currentUserId] || 0; // 0: no vote, 1: upvote, -1: downvote

                    if (isUpvote) {
                        if (userCurrentVote === 1) { // Already upvoted, unvote
                            updatedVotes--;
                            delete usersVoted[currentUserId];
                        } else if (userCurrentVote === -1) { // Downvoted, change to upvote
                            updatedVotes += 2; // Remove old downvote, add new upvote
                            usersVoted[currentUserId] = 1;
                        } else { // No vote, upvote
                            updatedVotes++;
                            usersVoted[currentUserId] = 1;
                        }
                    } else { // Downvote button clicked
                        if (userCurrentVote === -1) { // Already downvoted, unvote
                            updatedVotes++;
                            delete usersVoted[currentUserId];
                        } else if (userCurrentVote === 1) { // Upvoted, change to downvote
                            updatedVotes -= 2; // Remove old upvote, add new downvote
                            usersVoted[currentUserId] = -1;
                        } else { // No vote, downvote
                            updatedVotes--;
                            usersVoted[currentUserId] = -1;
                        }
                    }

                    await updateDoc(postDocRef, {
                        votes: updatedVotes,
                        usersVoted: usersVoted
                    });

                    voteCountSpan.textContent = updatedVotes;
                    // Update button active states
                    document.querySelectorAll(`.post-card[data-post-id="${postId}"] .vote-button`).forEach(btn => btn.classList.remove('active'));
                    if (usersVoted[currentUserId] === 1) {
                        button.classList.add('active');
                    } else if (usersVoted[currentUserId] === -1) {
                        otherButton.classList.add('active');
                    }

                } catch (error) {
                    console.error("Error updating vote:", error);
                    alert('Gagal memperbarui vote. Coba lagi.');
                } finally {
                    button.disabled = false;
                    if (otherButton) otherButton.disabled = false;
                }
            });
        });

        // --- Fungsi Logout ---
        async function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                try {
                    await signOut(auth);
                    localStorage.removeItem('lastLoggedInUserId'); // Jika Anda menggunakannya
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error("Error logging out:", error);
                    alert('Gagal logout. Coba lagi.');
                }
            }
        }

        // --- Fungsi untuk memuat profil pengguna dari Firestore untuk sidebar ---
        async function loadUserProfileSidebar(uid) {
            const userDocRef = doc(db, "users", uid);
            try {
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    document.getElementById('sidebarUsername').textContent = userData.username || 'Pengguna 9Gaul';
                    document.getElementById('loggedInEmailSidebar').textContent = userData.email || auth.currentUser.email;
                    document.getElementById('sidebarUserAvatar').src = userData.avatarUrl || 'https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P';
                } else {
                    console.warn("User profile not found in Firestore for UID:", uid);
                    document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                    document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
                document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
            }
        }

        // --- Fungsi Utama untuk Memuat Detail Grup ---
        async function loadGroupDetails(groupId, userId) {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('groupContentWrapper').style.display = 'none';
            document.getElementById('groupNotFoundMessage').style.display = 'none';

            try {
                const groupDocRef = doc(db, 'groups', groupId);
                const groupDocSnap = await getDoc(groupDocRef);

                if (!groupDocSnap.exists()) {
                    displayGroupNotFound("Grup yang Anda cari tidak ditemukan.");
                    return;
                }

                groupData = groupDocSnap.data(); // Simpan data grup secara global
                const isMember = groupData.members && groupData.members.includes(userId);

                // Tampilkan konten grup
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('groupContentWrapper').style.display = 'block';

                document.title = groupData.name + ' - 9Gaul';
                document.getElementById('groupNameHeader').textContent = groupData.name;
                document.getElementById('groupName').textContent = groupData.name;
                document.getElementById('groupMembers').textContent = `${(groupData.membersCount || 0).toLocaleString()} Anggota`;
                document.getElementById('groupDescription').textContent = groupData.description || 'Tidak ada deskripsi.';
                document.getElementById('groupAvatar').src = groupData.iconUrl || 'https://via.placeholder.com/100/CCCCCC/FFFFFF?text=G';
                document.getElementById('groupBanner').src = groupData.bannerUrl || 'https://via.placeholder.com/800x200/CCCCCC/202020?text=Banner+Grup';

                // Atur teks dan gaya tombol Gabung/Keluar
                const joinLeaveButton = document.getElementById('joinLeaveButton');
                if (isMember) {
                    joinLeaveButton.textContent = 'Bergabung';
                    joinLeaveButton.classList.add('active-join');
                    document.getElementById('createPostButton').style.display = 'inline-block'; // Tampilkan tombol buat post
                } else {
                    joinLeaveButton.textContent = 'Gabung';
                    joinLeaveButton.classList.remove('active-join');
                    document.getElementById('createPostButton').style.display = 'none'; // Sembunyikan tombol buat post
                }

                // Muat postingan grup
                await loadGroupPosts(groupId, userId);

            } catch (error) {
                console.error("Error loading group details:", error);
                displayGroupNotFound("Terjadi kesalahan saat memuat detail grup.");
            }
        }

        function displayGroupNotFound(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('groupContentWrapper').style.display = 'none';
            document.getElementById('groupNotFoundMessage').textContent = message;
            document.getElementById('groupNotFoundMessage').style.display = 'block';
            document.title = "Grup Tidak Ditemukan - 9Gaul";
            document.getElementById('groupNameHeader').textContent = "Grup Tidak Ditemukan";
            document.getElementById('groupName').textContent = "Grup Tidak Ditemukan";
            document.getElementById('groupMembers').textContent = "0 Anggota";
            document.getElementById('groupDescription').textContent = "Maaf, grup yang Anda cari tidak ditemukan.";
            document.getElementById('groupAvatar').src = "https://via.placeholder.com/100/CCCCCC/FFFFFF?text=NA";
            document.getElementById('groupBanner').src = "https://via.placeholder.com/800x200/CCCCCC/202020?text=Grup+Tidak+Ditemukan";
            document.getElementById('joinLeaveButton').style.display = 'none';
            document.getElementById('createPostButton').style.display = 'none';
            document.querySelector('.share-button-group').style.display = 'none';
            document.querySelector('.more-options-group').style.display = 'none';
            document.getElementById('groupPostsFeed').innerHTML = '<p class="page-placeholder" style="padding: 20px;">Tidak ada postingan untuk grup ini.</p>';
        }

        // --- Fungsi untuk Memuat Postingan Grup ---
        async function loadGroupPosts(groupId, currentUserId) {
            const postsFeedContainer = document.getElementById('groupPostsFeed');
            postsFeedContainer.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Memuat postingan...</p>';

            try {
                // Asumsi: Setiap postingan memiliki field 'groupId'
                const postsCollectionRef = collection(db, 'posts');
                const q = query(postsCollectionRef, where('groupId', '==', groupId), orderBy('createdAt', 'desc'), limit(10)); // Ambil 10 postingan terbaru
                const postsSnapshot = await getDocs(q);

                if (postsSnapshot.empty) {
                    postsFeedContainer.innerHTML = '<p class="page-placeholder" style="padding: 20px;">Belum ada postingan di grup ini.</p>';
                    return;
                }

                postsFeedContainer.innerHTML = ''; // Kosongkan loading message
                for (const postDoc of postsSnapshot.docs) {
                    const post = postDoc.data();
                    const postId = postDoc.id;

                    // Ambil data user yang membuat postingan
                    let postUser = { username: 'Pengguna Tak Dikenal', avatarUrl: 'https://via.placeholder.com/35/cccccc/000000?text=U' };
                    if (post.userId) {
                        const userSnap = await getDoc(doc(db, 'users', post.userId));
                        if (userSnap.exists()) {
                            postUser = userSnap.data();
                        }
                    }

                    // Tentukan status vote pengguna
                    const usersVoted = post.usersVoted || {};
                    const userCurrentVote = usersVoted[currentUserId] || 0; // 0: no vote, 1: upvote, -1: downvote
                    const upvoteActiveClass = userCurrentVote === 1 ? 'active' : '';
                    const downvoteActiveClass = userCurrentVote === -1 ? 'active' : '';

                    const postItem = `
                        <div class="post-card" data-post-id="${postId}">
                            <div class="post-header">
                                <img src="${postUser.avatarUrl || 'https://via.placeholder.com/35/cccccc/000000?text=U'}" alt="${postUser.username || 'User'} Avatar">
                                <div class="post-info">
                                    <strong>${postUser.username || (postUser.email ? postUser.email.split('@')[0] : 'Pengguna')}</strong>
                                    <span>${formatTimestamp(post.createdAt)}</span>
                                </div>
                            </div>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Image" class="post-image">` : ''}
                            <p class="post-text">${post.text || ''}</p>
                            <div class="post-actions">
                                <button class="vote-button upvote ${upvoteActiveClass}"><i class="fas fa-arrow-up"></i></button>
                                <span class="vote-count">${post.votes || 0}</span>
                                <button class="vote-button downvote ${downvoteActiveClass}"><i class="fas fa-arrow-down"></i></button>
                                <button class="comment-button" onclick="alert('Fitur komentar akan datang!')"><i class="fas fa-comment-alt"></i> ${post.commentCount || 0}</button>
                                <button class="share-button" onclick="alert('Fitur bagikan postingan akan datang!')"><i class="fas fa-share"></i> Bagikan</button>
                            </div>
                        </div>
                    `;
                    postsFeedContainer.innerHTML += postItem;
                }

            } catch (error) {
                console.error("Error loading group posts:", error);
                postsFeedContainer.innerHTML = '<p class="message-error" style="text-align: center;">Gagal memuat postingan grup.</p>';
            }
        }

        // Helper function to format timestamp (reused from dashboard)
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Beberapa waktu lalu';
            // Firebase Timestamps have a toDate() method
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.round(diffMs / 1000);
            const diffMinutes = Math.round(diffMs / (1000 * 60));
            const diffHours = Math.round(diffMs / (1000 * 60 * 60));
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

            if (diffSeconds < 10) return 'Baru saja';
            if (diffMinutes < 1) return `${diffSeconds} detik yang lalu`;
            if (diffMinutes < 60) return `${diffMinutes} menit yang lalu`;
            if (diffHours < 24) return `${diffHours} jam yang lalu`;
            if (diffDays < 7) return `${diffDays} hari yang lalu`;
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        // Fungsi untuk navigasi ke halaman buat post
        function navigateToCreatePost() {
            if (currentGroupId) {
                window.location.href = `create-post.html?groupId=${currentGroupId}`;
            } else {
                alert('Tidak dapat membuat post karena ID grup tidak ditemukan.');
            }
        }
    </script>
</body>
</html>
