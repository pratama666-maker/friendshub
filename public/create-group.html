<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Grup Baru - 9Gaul</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h2><i class="fas fa-laugh-squint"></i> 9Gaul</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-home"></i> Beranda</a></li>
                    <li><a href="explore.html"><i class="fas fa-compass"></i> Explore</a></li>
                    <li><a href="groups.html" class="active"><i class="fas fa-users"></i> Grup</a></li>
                    <li class="separator"></li>
                    <li><a href="service-center.html"><i class="fas fa-headset"></i> Service Center</a></li>
                    <li><a href="donate.html"><i class="fas fa-heart"></i> Donasi</a></li>
                </ul>
            </nav>
            <div class="sidebar-profile">
                <a href="profile.html"><img src="https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P" alt="Profil Pengguna" id="sidebarUserAvatar"></a>
                <div class="profile-info">
                    <a href="profile.html"><strong id="sidebarUsername">Loading...</strong></a>
                    <span class="user-email" id="loggedInEmailSidebar">Loading...</span>
                </div>
                <a href="#" class="logout-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button class="back-button-mobile" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
                <h1>Buat Grup Baru</h1>
                <div class="header-actions">
                    <button class="profile-icon-mobile-header" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
                </div>
            </header>

            <section class="create-group-form-container">
                <form id="createGroupForm" class="group-form-card">
                    <div class="input-group">
                        <label for="groupName">Nama Grup</label>
                        <input type="text" id="groupName" placeholder="Masukkan nama grup Anda" required maxlength="50">
                        <small>Maksimal 50 karakter.</small>
                    </div>

                    <div class="input-group">
                        <label for="groupDescription">Deskripsi Grup</label>
                        <textarea id="groupDescription" rows="5" placeholder="Jelaskan tujuan dan tema grup Anda..." required maxlength="500"></textarea>
                        <small>Maksimal 500 karakter.</small>
                    </div>

                    <div class="input-group">
                        <label for="groupCategory">Kategori Grup</label>
                        <select id="groupCategory" required>
                            <option value="">Pilih Kategori</option>
                            <option value="meme">Meme</option>
                            <option value="teknologi">Teknologi</option>
                            <option value="game">Game</option>
                            <option value="seni">Seni & Desain</option>
                            <option value="olahraga">Olahraga</option>
                            <option value="kuliner">Kuliner</option>
                            <option value="edukasi">Edukasi</option>
                            <option value="musik">Musik</option>
                            <option value="travel">Travel</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>

                    <div class="input-group file-upload-group">
                        <label for="groupAvatarUpload">Gambar Profil Grup (Avatar)</label>
                        <div class="file-upload-preview">
                            <img id="avatarPreview" src="https://via.placeholder.com/100/3a3a3a/b0b0b0?text=Avatar" alt="Avatar Preview">
                            <input type="file" id="groupAvatarUpload" accept="image/*">
                            <button type="button" class="upload-button" onclick="document.getElementById('groupAvatarUpload').click()"><i class="fas fa-upload"></i> Unggah Avatar</button>
                        </div>
                        <small>Ukuran rekomendasi: 200x200px.</small>
                    </div>

                    <div class="input-group file-upload-group">
                        <label for="groupBannerUpload">Gambar Sampul Grup (Banner)</label>
                        <div class="file-upload-preview banner-preview">
                            <img id="bannerPreview" src="https://via.placeholder.com/600x150/3a3a3a/b0b0b0?text=Banner" alt="Banner Preview">
                            <input type="file" id="groupBannerUpload" accept="image/*">
                            <button type="button" class="upload-button" onclick="document.getElementById('groupBannerUpload').click()"><i class="fas fa-upload"></i> Unggah Banner</button>
                        </div>
                        <small>Ukuran rekomendasi: 800x200px.</small>
                    </div>
                    
                    <button type="submit" class="button-primary-submit" id="createGroupButton">Buat Grup</button>
                    <p id="errorMessage" class="message-error" style="display: none;"></p>
                    <p id="successMessage" class="message-success" style="display: none;"></p>
                </form>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span class="nav-text">Beranda</span></a>
            <a href="explore.html" class="nav-item"><i class="fas fa-compass"></i><span class="nav-text">Explore</span></a>
            <a href="groups.html" class="nav-item active"><i class="fas fa-users"></i><span class="nav-text">Grup</span></a>
        </nav>
    </div>

    <script type="module">
        // Import Firebase modules dari firebase-config.js
        import { auth, signOut, onAuthStateChanged, db, collection, addDoc, doc, getDoc, updateDoc, arrayUnion, storage, ref, uploadBytes, getDownloadURL } from './firebase-config.js';

        let currentUserId = null; // Untuk menyimpan UID pengguna yang sedang login

        document.addEventListener('DOMContentLoaded', async () => {
            // Cek status autentikasi Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Set UID pengguna yang sedang login
                    console.log("User logged in:", user.uid);
                    await loadUserProfileSidebar(user.uid); // Muat data profil untuk sidebar
                } else {
                    console.log("No user logged in. Redirecting to index.html");
                    window.location.href = 'index.html'; // Redirect jika belum login
                }
            });

            // Fungsi untuk memuat profil pengguna dari Firestore untuk sidebar
            async function loadUserProfileSidebar(uid) {
                const userDocRef = doc(db, "users", uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        document.getElementById('sidebarUsername').textContent = userData.username || 'Pengguna 9Gaul';
                        document.getElementById('loggedInEmailSidebar').textContent = userData.email || auth.currentUser.email;
                        document.getElementById('sidebarUserAvatar').src = userData.avatarUrl || 'https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P';
                    } else {
                        console.warn("User profile not found in Firestore for UID:", uid);
                        // Fallback ke info dasar jika profil tidak ditemukan
                        document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                        document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                    }
                } catch (error) {
                    console.error("Error loading user profile:", error);
                    // Fallback jika terjadi error
                    document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                    document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                }
            }


            // Highlighting the active link
            const path = window.location.pathname.split('/').pop();
            document.querySelectorAll('.sidebar-nav a, .bottom-nav .nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === path) {
                    link.classList.add('active');
                }
            });

            // Image preview logic for Avatar
            const avatarUpload = document.getElementById('groupAvatarUpload');
            const avatarPreview = document.getElementById('avatarPreview');
            avatarUpload.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        avatarPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    avatarPreview.src = "https://via.placeholder.com/100/3a3a3a/b0b0b0?text=Avatar"; // Default placeholder
                }
            });

            // Image preview logic for Banner
            const bannerUpload = document.getElementById('groupBannerUpload');
            const bannerPreview = document.getElementById('bannerPreview');
            bannerUpload.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        bannerPreview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    bannerPreview.src = "https://via.placeholder.com/600x150/3a3a3a/b0b0b0?text=Banner"; // Default placeholder
                }
            });

            // Form submission logic
            const createGroupForm = document.getElementById('createGroupForm');
            const createGroupButton = document.getElementById('createGroupButton');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            createGroupForm.addEventListener('submit', async function(event) {
                event.preventDefault(); // Mencegah reload halaman

                if (!currentUserId) {
                    showError("Anda harus login untuk membuat grup.");
                    return;
                }

                createGroupButton.disabled = true;
                createGroupButton.textContent = 'Membuat Grup...';
                hideMessages();

                const groupName = document.getElementById('groupName').value.trim();
                const groupDescription = document.getElementById('groupDescription').value.trim();
                const groupCategory = document.getElementById('groupCategory').value;
                const avatarFile = document.getElementById('groupAvatarUpload').files[0];
                const bannerFile = document.getElementById('groupBannerUpload').files[0];

                if (!groupName || !groupDescription || !groupCategory) {
                    showError("Mohon lengkapi semua bidang yang wajib diisi.");
                    createGroupButton.disabled = false;
                    createGroupButton.textContent = 'Buat Grup';
                    return;
                }

                try {
                    let avatarUrl = avatarPreview.src; // Default ke placeholder atau preview jika tidak ada upload baru
                    let bannerUrl = bannerPreview.src; // Default ke placeholder atau preview jika tidak ada upload baru

                    if (avatarFile) {
                        const avatarStorageRef = ref(storage, `group_avatars/${currentUserId}_${Date.now()}_${avatarFile.name}`);
                        const avatarSnapshot = await uploadBytes(avatarStorageRef, avatarFile);
                        avatarUrl = await getDownloadURL(avatarSnapshot.ref);
                    }

                    if (bannerFile) {
                        const bannerStorageRef = ref(storage, `group_banners/${currentUserId}_${Date.now()}_${bannerFile.name}`);
                        const bannerSnapshot = await uploadBytes(bannerStorageRef, bannerFile);
                        bannerUrl = await getDownloadURL(bannerSnapshot.ref);
                    }

                    // Tambahkan grup baru ke koleksi 'groups'
                    const newGroupRef = await addDoc(collection(db, 'groups'), {
                        name: groupName,
                        description: groupDescription,
                        category: groupCategory,
                        iconUrl: avatarUrl, // Gunakan iconUrl untuk avatar
                        bannerUrl: bannerUrl,
                        createdAt: new Date(),
                        createdBy: currentUserId,
                        members: [currentUserId], // Pembuat grup otomatis menjadi anggota pertama
                        membersCount: 1, // Hitungan anggota awal
                        postsCount: 0 // Jumlah postingan awal
                    });

                    // Tambahkan ID grup ke array 'joinedGroups' di dokumen pengguna
                    const userDocRef = doc(db, 'users', currentUserId);
                    await updateDoc(userDocRef, {
                        joinedGroups: arrayUnion(newGroupRef.id)
                    });

                    showSuccess(`Grup "${groupName}" berhasil dibuat! Mengarahkan...`);
                    setTimeout(() => {
                        window.location.href = `view-group.html?id=${newGroupRef.id}`; // Redirect ke halaman grup yang baru dibuat
                    }, 2000);

                } catch (error) {
                    console.error("Error creating group:", error);
                    showError(`Gagal membuat grup: ${error.message}`);
                    createGroupButton.disabled = false;
                    createGroupButton.textContent = 'Buat Grup';
                }
            });

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }

            function showSuccess(message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
            }

            function hideMessages() {
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
            }
        });

        // --- Fungsi Logout ---
        async function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                try {
                    await signOut(auth); // Menggunakan signOut dari Firebase Auth
                    // Hapus UID dari localStorage, jika masih digunakan untuk tujuan lain
                    localStorage.removeItem('lastLoggedInUserId');
                    window.location.href = 'index.html'; // Redirect ke halaman login
                } catch (error) {
                    console.error("Error logging out:", error);
                    alert('Gagal logout. Coba lagi.');
                }
            }
        }
    </script>
</body>
</html>
