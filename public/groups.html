<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grup - 9Gaul</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h2><i class="fas fa-laugh-squint"></i> 9Gaul</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-home"></i> Beranda</a></li>
                    <li><a href="explore.html"><i class="fas fa-compass"></i> Explore</a></li>
                    <li><a href="groups.html" class="active"><i class="fas fa-users"></i> Grup</a></li>
                    <li class="separator"></li>
                    <li><a href="service-center.html"><i class="fas fa-headset"></i> Service Center</a></li>
                    <li><a href="donate.html"><i class="fas fa-heart"></i> Donasi</a></li>
                </ul>
            </nav>
            <div class="sidebar-profile">
                <a href="profile.html"><img src="https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P" alt="Profil Pengguna" id="sidebarUserAvatar"></a>
                <div class="profile-info">
                    <a href="profile.html"><strong id="sidebarUsername">Loading...</strong></a>
                    <span class="user-email" id="loggedInEmailSidebar">Loading...</span>
                </div>
                <a href="#" class="logout-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button class="back-button-mobile" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
                <h1>Grup</h1>
                <div class="header-actions">
                    <button class="profile-icon-mobile-header" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
                </div>
            </header>

            <section class="groups-page-container">
                <div class="groups-header">
                    <h1>Grup</h1>
                    <button class="create-group-btn" onclick="window.location.href='create-group.html'">
                        <i class="fas fa-plus"></i> Buat Grup
                    </button>
                </div>

                <div class="group-search-bar">
                    <input type="text" id="groupSearchBarInput" placeholder="Cari grup...">
                    <button id="groupSearchButton"><i class="fas fa-search"></i></button>
                </div>

                <div class="group-categories">
                    <span class="category-title"><i class="fas fa-tags"></i> Kategori Populer:</span>
                    <div class="category-list" id="popularCategories">
                        </div>
                </div>

                <div class="group-list-section">
                    <h2 id="groupListTitle">Grup yang Direkomendasikan</h2>
                    <div class="recommended-groups-grid" id="groupsContainer">
                        <p style="text-align: center; color: var(--sub-text-color);">Memuat grup...</p>
                    </div>
                    <p id="noGroupsFound" style="display: none; text-align: center; color: var(--sub-text-color);">Tidak ada grup ditemukan.</p>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span class="nav-text">Beranda</span></a>
            <a href="explore.html" class="nav-item"><i class="fas fa-compass"></i><span class="nav-text">Explore</span></a>
            <a href="groups.html" class="nav-item active"><i class="fas fa-users"></i><span class="nav-text">Grup</span></a>
        </nav>
    </div>

    <script type="module">
        // Import Firebase modules dari firebase-config.js
        import { auth, signOut, onAuthStateChanged, db, collection, getDocs, query, orderBy, where, doc, getDoc, updateDoc, arrayUnion, arrayRemove, limit } from './firebase-config.js';

        let currentUserId = null; // Untuk menyimpan UID pengguna yang sedang login

        document.addEventListener('DOMContentLoaded', async () => {
            // Cek status autentikasi Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Set UID pengguna yang sedang login
                    console.log("User logged in:", user.uid);
                    await loadUserProfileSidebar(user.uid); // Muat data profil untuk sidebar
                    await loadRecommendedGroups();
                    await loadPopularCategories();
                } else {
                    console.log("No user logged in. Redirecting to index.html");
                    window.location.href = 'index.html'; // Redirect jika belum login
                }
            });

            // Fungsi untuk memuat profil pengguna dari Firestore untuk sidebar
            async function loadUserProfileSidebar(uid) {
                const userDocRef = doc(db, "users", uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        document.getElementById('sidebarUsername').textContent = userData.username || 'Pengguna 9Gaul';
                        document.getElementById('loggedInEmailSidebar').textContent = userData.email || auth.currentUser.email;
                        document.getElementById('sidebarUserAvatar').src = userData.avatarUrl || 'https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P';
                    } else {
                        console.warn("User profile not found in Firestore for UID:", uid);
                        // Fallback ke info dasar jika profil tidak ditemukan
                        document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                        document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                    }
                } catch (error) {
                    console.error("Error loading user profile:", error);
                    // Fallback jika terjadi error
                    document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                    document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                }
            }

            // Highlighting the active link
            const path = window.location.pathname.split('/').pop();
            document.querySelectorAll('.sidebar-nav a, .bottom-nav .nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === path) {
                    link.classList.add('active');
                }
            });

            // Event listener untuk tombol Gabung/Bergabung
            document.addEventListener('click', async (event) => {
                if (event.target.classList.contains('join-button')) {
                    event.preventDefault();
                    event.stopPropagation();

                    if (!currentUserId) {
                        alert('Anda harus login untuk bergabung dengan grup.');
                        return;
                    }

                    const button = event.target;
                    const groupId = button.closest('.group-item').dataset.groupId;
                    const groupDocRef = doc(db, 'groups', groupId);
                    const userDocRef = doc(db, 'users', currentUserId);

                    try {
                        const groupDocSnap = await getDoc(groupDocRef);
                        const userDocSnap = await getDoc(userDocRef);

                        if (!groupDocSnap.exists() || !userDocSnap.exists()) {
                            alert('Grup atau profil pengguna tidak ditemukan.');
                            return;
                        }

                        const groupData = groupDocSnap.data();
                        const userData = userDocSnap.data();

                        const isMember = groupData.members && groupData.members.includes(currentUserId);

                        if (isMember) {
                            // Keluar dari grup
                            await updateDoc(groupDocRef, {
                                members: arrayRemove(currentUserId),
                                membersCount: (groupData.membersCount || 1) - 1 // Kurangi hitungan anggota
                            });
                            await updateDoc(userDocRef, {
                                joinedGroups: arrayRemove(groupId)
                            });
                            button.textContent = 'Gabung';
                            button.style.backgroundColor = 'var(--button-primary-bg)';
                            button.style.color = 'white';
                            alert('Anda telah keluar dari grup.');
                        } else {
                            // Gabung grup
                            await updateDoc(groupDocRef, {
                                members: arrayUnion(currentUserId),
                                membersCount: (groupData.membersCount || 0) + 1 // Tambah hitungan anggota
                            });
                            await updateDoc(userDocRef, {
                                joinedGroups: arrayUnion(groupId)
                            });
                            button.textContent = 'Bergabung';
                            button.style.backgroundColor = 'var(--accent-color)';
                            button.style.color = 'var(--bg-color)';
                            alert('Anda telah bergabung dengan grup!');
                        }
                    } catch (error) {
                        console.error("Error joining/leaving group:", error);
                        alert('Gagal memperbarui status grup. Coba lagi.');
                    }
                }
            });

            // Event listener untuk search bar
            const searchInput = document.getElementById('groupSearchBarInput');
            const searchButton = document.getElementById('groupSearchButton');

            searchButton.addEventListener('click', () => {
                performSearch(searchInput.value);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(searchInput.value);
                }
            });

            // Event listener untuk kategori populer
            document.getElementById('popularCategories').addEventListener('click', (event) => {
                if (event.target.classList.contains('category-tag')) {
                    const category = event.target.textContent;
                    performSearch('', category); // Cari berdasarkan kategori
                    searchInput.value = ''; // Kosongkan input search bar
                }
            });
        });

        // --- Fungsi Logout ---
        async function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                try {
                    await signOut(auth); // Menggunakan signOut dari Firebase Auth
                    // Hapus UID dari localStorage, jika masih digunakan untuk tujuan lain
                    localStorage.removeItem('lastLoggedInUserId');
                    window.location.href = 'index.html'; // Redirect ke halaman login
                } catch (error) {
                    console.error("Error logging out:", error);
                    alert('Gagal logout. Coba lagi.');
                }
            }
        }

        // --- Fungsi untuk Memuat Grup yang Direkomendasikan ---
        async function loadRecommendedGroups() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Memuat grup...</p>';
            document.getElementById('noGroupsFound').style.display = 'none';
            document.getElementById('groupListTitle').textContent = 'Grup yang Direkomendasikan';

            try {
                const groupsCollectionRef = collection(db, 'groups');
                // Mengambil grup berdasarkan jumlah anggota, atau kriteria lain
                const q = query(groupsCollectionRef, orderBy('membersCount', 'desc'), limit(10)); // Ambil 10 grup teratas
                const groupsSnapshot = await getDocs(q);

                if (groupsSnapshot.empty) {
                    container.innerHTML = '';
                    document.getElementById('noGroupsFound').textContent = 'Tidak ada grup yang direkomendasikan.';
                    document.getElementById('noGroupsFound').style.display = 'block';
                    return;
                }

                container.innerHTML = '';
                const userDocSnap = currentUserId ? await getDoc(doc(db, 'users', currentUserId)) : null;
                const userJoinedGroups = userDocSnap && userDocSnap.exists() ? userDocSnap.data().joinedGroups || [] : [];

                groupsSnapshot.forEach(doc => {
                    const group = doc.data();
                    const isMember = userJoinedGroups.includes(doc.id);
                    const buttonText = isMember ? 'Bergabung' : 'Gabung';
                    const buttonStyle = isMember ? 'background-color: var(--accent-color); color: var(--bg-color);' : '';

                    const groupItem = `
                        <a href="view-group.html?id=${doc.id}" class="group-item" data-group-id="${doc.id}">
                            <img src="${group.iconUrl || 'https://via.placeholder.com/50/cccccc/000000?text=G'}" alt="${group.name}">
                            <div class="group-info">
                                <strong>${group.name}</strong>
                                <span>${(group.membersCount || 0).toLocaleString()} Anggota</span>
                            </div>
                            <button class="join-button" style="${buttonStyle}">${buttonText}</button>
                        </a>
                    `;
                    container.innerHTML += groupItem;
                });
            } catch (error) {
                console.error("Error loading recommended groups:", error);
                container.innerHTML = '<p style="text-align: center; color: var(--message-error-text); background-color: var(--message-error-bg); padding: 10px; border-radius: 5px;">Gagal memuat rekomendasi grup.</p>';
            }
        }

        // --- Fungsi untuk Memuat Kategori Populer ---
        async function loadPopularCategories() {
            const container = document.getElementById('popularCategories');
            container.innerHTML = ''; // Clear existing tags

            try {
                // Anda bisa mendefinisikan kategori secara statis atau mengambilnya dari Firestore jika ada koleksi 'categories'
                const popularCategories = ["Meme", "Teknologi", "Game", "Seni", "Olahraga", "Kuliner", "Musik", "Film", "Buku"]; // Contoh kategori

                popularCategories.forEach(category => {
                    const categoryTag = `<span class="category-tag">${category}</span>`;
                    container.innerHTML += categoryTag;
                });
            } catch (error) {
                console.error("Error loading popular categories:", error);
                // Fallback ke kategori statis jika ada masalah
                container.innerHTML = `
                    <span class="category-tag">Meme</span>
                    <span class="category-tag">Teknologi</span>
                    <span class="category-tag">Game</span>
                    <span class="category-tag">Seni</span>
                    <span class="category-tag">Olahraga</span>
                    <span class="category-tag">Kuliner</span>
                `;
            }
        }

        // --- Fungsi untuk Melakukan Pencarian Grup ---
        async function performSearch(queryText, categoryFilter = null) {
            const container = document.getElementById('groupsContainer');
            const noGroupsFound = document.getElementById('noGroupsFound');
            const groupListTitle = document.getElementById('groupListTitle');

            container.innerHTML = '<p style="text-align: center; color: var(--sub-text-color);">Mencari grup...</p>';
            noGroupsFound.style.display = 'none';

            let q;
            const groupsCollectionRef = collection(db, 'groups');

            if (categoryFilter) {
                groupListTitle.textContent = `Grup Kategori: ${categoryFilter}`;
                // Pastikan 'category' field ada di dokumen grup Firestore Anda
                q = query(groupsCollectionRef, where('category', '==', categoryFilter), orderBy('membersCount', 'desc'), limit(20));
            } else if (queryText.trim()) {
                groupListTitle.textContent = `Hasil Pencarian untuk "${queryText}"`;
                // Pencarian 'starts with' untuk nama grup
                q = query(groupsCollectionRef,
                          where('name', '>=', queryText),
                          where('name', '<=', queryText + '\uf8ff'),
                          orderBy('name'), // Order by name for consistency with 'startsWith' search
                          limit(20));
            } else {
                // Jika tidak ada query atau filter, kembali ke rekomendasi
                await loadRecommendedGroups();
                return;
            }

            try {
                const groupsSnapshot = await getDocs(q);

                if (groupsSnapshot.empty) {
                    container.innerHTML = '';
                    noGroupsFound.textContent = `Tidak ada grup ${categoryFilter ? `dalam kategori "${categoryFilter}"` : `yang cocok dengan "${queryText}"`}.`;
                    noGroupsFound.style.display = 'block';
                    return;
                }

                container.innerHTML = ''; // Kosongkan loading message
                const userDocSnap = currentUserId ? await getDoc(doc(db, 'users', currentUserId)) : null;
                const userJoinedGroups = userDocSnap && userDocSnap.exists() ? userDocSnap.data().joinedGroups || [] : [];

                groupsSnapshot.forEach(doc => {
                    const group = doc.data();
                    const isMember = userJoinedGroups.includes(doc.id);
                    const buttonText = isMember ? 'Bergabung' : 'Gabung';
                    const buttonStyle = isMember ? 'background-color: var(--accent-color); color: var(--bg-color);' : '';

                    const groupItem = `
                        <a href="view-group.html?id=${doc.id}" class="group-item" data-group-id="${doc.id}">
                            <img src="${group.iconUrl || 'https://via.placeholder.com/50/cccccc/000000?text=G'}" alt="${group.name}">
                            <div class="group-info">
                                <strong>${group.name}</strong>
                                <span>${(group.membersCount || 0).toLocaleString()} Anggota</span>
                            </div>
                            <button class="join-button" style="${buttonStyle}">${buttonText}</button>
                        </a>
                    `;
                    container.innerHTML += groupItem;
                });

            } catch (error) {
                console.error("Error performing group search:", error);
                container.innerHTML = '<p style="text-align: center; color: var(--message-error-text); background-color: var(--message-error-bg); padding: 10px; border-radius: 5px;">Gagal mencari grup.</p>';
            }
        }
    </script>
</body>
</html>
