<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beranda - 9Gaul</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-laugh-squint"></i> 9Gaul</h2>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html" class="active"><i class="fas fa-home"></i> Beranda</a></li>
                    <li><a href="explore.html"><i class="fas fa-compass"></i> Explore</a></li>
                    <li><a href="groups.html"><i class="fas fa-users"></i> Grup</a></li>
                    <li class="separator"></li>
                    <li><a href="service-center.html"><i class="fas fa-headset"></i> Service Center</a></li>
                    <li><a href="donate.html"><i class="fas fa-heart"></i> Donasi</a></li>
                </ul>
            </nav>
            <div class="sidebar-profile">
                <a href="profile.html"><img src="https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P" alt="Profil Pengguna" id="sidebarUserAvatar"></a>
                <div class="profile-info">
                    <a href="profile.html"><strong id="sidebarUsername">Loading...</strong></a>
                    <span class="user-email" id="loggedInEmailSidebar">Loading...</span>
                </div>
                <a href="#" class="logout-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="search-bar-desktop">
                    <input type="text" placeholder="Cari...">
                    <button><i class="fas fa-search"></i></button>
                </div>
                <div class="header-actions">
                    <button onclick="window.location.href='notifications.html'"><i class="fas fa-bell"></i></button>
                    <button onclick="window.location.href='create-post.html'"><i class="fas fa-plus"></i></button>
                    <button class="profile-icon-mobile-header" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
                </div>
            </header>

            <section class="post-feed" id="postFeed">
                <p class="loading-message">Memuat postingan...</p>
                <p class="no-posts-message" style="display: none;">Belum ada postingan. Ayo buat yang pertama!</p>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item active"><i class="fas fa-home"></i><span class="nav-text">Beranda</span></a>
            <a href="explore.html" class="nav-item"><i class="fas fa-compass"></i><span class="nav-text">Explore</span></a>
            <a href="groups.html" class="nav-item"><i class="fas fa-users"></i><span class="nav-text">Grup</span></a>
        </nav>
    </div>

    <script type="module">
        import { auth, signOut, onAuthStateChanged, db, collection, getDocs, query, orderBy, doc, getDoc, updateDoc } from './firebase-config.js';

        // Global variable to store current user's UID
        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Cek status autentikasi Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Set UID pengguna yang sedang login
                    console.log("User logged in:", user.uid);
                    await loadUserProfile(user.uid);
                    await loadPosts();
                } else {
                    console.log("No user logged in. Redirecting to index.html");
                    window.location.href = 'index.html'; // Redirect jika belum login
                }
            });

            // Fungsi untuk memuat profil pengguna dari Firestore
            async function loadUserProfile(uid) {
                const userDocRef = doc(db, "users", uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        document.getElementById('sidebarUsername').textContent = userData.username || 'Pengguna 9Gaul';
                        document.getElementById('loggedInEmailSidebar').textContent = userData.email || auth.currentUser.email;
                        document.getElementById('sidebarUserAvatar').src = userData.avatarUrl || 'https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P';
                    } else {
                        console.warn("User profile not found in Firestore for UID:", uid);
                        // Fallback to basic info if profile not found
                        document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                        document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                    }
                } catch (error) {
                    console.error("Error loading user profile:", error);
                    // Fallback in case of error
                    document.getElementById('sidebarUsername').textContent = auth.currentUser.email.split('@')[0];
                    document.getElementById('loggedInEmailSidebar').textContent = auth.currentUser.email;
                }
            }

            // Fungsi untuk memuat postingan dari Firestore
            async function loadPosts() {
                const postFeed = document.getElementById('postFeed');
                postFeed.innerHTML = '<p class="loading-message">Memuat postingan...</p>'; // Tampilkan loading
                const postsCollectionRef = collection(db, "posts");
                const q = query(postsCollectionRef, orderBy("createdAt", "desc")); // Urutkan berdasarkan waktu terbaru

                try {
                    const querySnapshot = await getDocs(q);
                    let postsHtml = '';
                    if (querySnapshot.empty) {
                        postFeed.innerHTML = '<p class="no-posts-message">Belum ada postingan. Ayo buat yang pertama!</p>';
                    } else {
                        querySnapshot.forEach((doc) => {
                            const post = doc.data();
                            const postId = doc.id; // ID dokumen Firestore adalah ID post
                            // Gunakan data dari Firestore
                            postsHtml += `
                                <div class="post-card" data-post-id="${postId}">
                                    <div class="post-header">
                                        <img src="${post.userAvatar || 'https://via.placeholder.com/30/f0b48a/FFFFFF?text=U'}" alt="Profil">
                                        <div class="post-info">
                                            <strong>${post.username || 'Pengguna Anonim'}</strong>
                                            <span>${formatTimestamp(post.createdAt)}</span>
                                        </div>
                                        <i class="fas fa-ellipsis-h post-options-icon"></i>
                                    </div>
                                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post Foto" class="post-image">` : ''}
                                    ${post.text ? `<p class="post-text">${post.text}</p>` : ''}
                                    <div class="post-actions">
                                        <button class="vote-button upvote ${post.upvotedBy && post.upvotedBy.includes(currentUserId) ? 'active' : ''}" data-action="upvote"><i class="fas fa-arrow-up"></i></button>
                                        <span class="vote-count">${post.votes || 0}</span>
                                        <button class="vote-button downvote ${post.downvotedBy && post.downvotedBy.includes(currentUserId) ? 'active' : ''}" data-action="downvote"><i class="fas fa-arrow-down"></i></button>
                                        <button class="comment-button" data-post-id="${postId}"><i class="fas fa-comment"></i> ${post.commentsCount || 0}</button>
                                        <button class="share-button"><i class="fas fa-share-alt"></i></button>
                                    </div>
                                    ${post.caption ? `<p class="post-caption">${post.caption}</p>` : ''}
                                </div>
                            `;
                        });
                        postFeed.innerHTML = postsHtml;
                    }
                } catch (error) {
                    console.error("Error loading posts:", error);
                    postFeed.innerHTML = '<p class="error-message">Gagal memuat postingan. Coba lagi nanti.</p>';
                }
                attachPostEventListeners(); // Attach listeners after posts are loaded
            }

            // Helper function to format timestamp
            function formatTimestamp(timestamp) {
                if (!timestamp) return 'Beberapa waktu lalu';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp); // Handle Firestore Timestamp or JS Date
                const now = new Date();
                const diffMs = now - date;
                const diffMinutes = Math.round(diffMs / (1000 * 60));
                const diffHours = Math.round(diffMs / (1000 * 60 * 60));
                const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

                if (diffMinutes < 1) return 'Baru saja';
                if (diffMinutes < 60) return `${diffMinutes} menit yang lalu`;
                if (diffHours < 24) return `${diffHours} jam yang lalu`;
                if (diffDays < 7) return `${diffDays} hari yang lalu`;
                return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            // Function to attach event listeners to dynamically loaded posts
            function attachPostEventListeners() {
                // Tambahkan event listener untuk tombol komentar
                document.querySelectorAll('.comment-button').forEach(button => {
                    button.removeEventListener('click', handleCommentClick); // Prevent duplicate listeners
                    button.addEventListener('click', handleCommentClick);
                });

                // Tambahkan event listener untuk tombol vote (upvote/downvote)
                document.querySelectorAll('.vote-button').forEach(button => {
                    button.removeEventListener('click', handleVoteClick); // Prevent duplicate listeners
                    button.addEventListener('click', handleVoteClick);
                });
            }

            async function handleCommentClick() {
                const postId = this.dataset.postId;
                window.location.href = `view-comment.html?postId=${postId}`;
            }

            async function handleVoteClick(event) {
                if (!currentUserId) {
                    alert('Anda harus login untuk melakukan vote.');
                    return;
                }

                const button = event.currentTarget; // Use currentTarget to ensure we get the button
                const postId = button.closest('.post-card').dataset.postId;
                const action = button.dataset.action; // 'upvote' or 'downvote'
                const voteCountSpan = button.parentElement.querySelector('.vote-count');
                const upvoteButton = button.parentElement.querySelector('.upvote');
                const downvoteButton = button.parentElement.querySelector('.downvote');

                const postRef = doc(db, "posts", postId);

                try {
                    const postSnap = await getDoc(postRef);
                    if (postSnap.exists()) {
                        const postData = postSnap.data();
                        let currentVotes = postData.votes || 0;
                        let upvotedBy = postData.upvotedBy || [];
                        let downvotedBy = postData.downvotedBy || [];

                        const isCurrentlyUpvoted = upvotedBy.includes(currentUserId);
                        const isCurrentlyDownvoted = downvotedBy.includes(currentUserId);

                        if (action === 'upvote') {
                            if (isCurrentlyUpvoted) {
                                // Undo upvote
                                upvotedBy = upvotedBy.filter(uid => uid !== currentUserId);
                                currentVotes--;
                            } else {
                                // Upvote
                                upvotedBy.push(currentUserId);
                                currentVotes++;
                                // If previously downvoted, undo downvote
                                if (isCurrentlyDownvoted) {
                                    downvotedBy = downvotedBy.filter(uid => uid !== currentUserId);
                                    currentVotes++; // Compensate for the downvote removal
                                }
                            }
                        } else if (action === 'downvote') {
                            if (isCurrentlyDownvoted) {
                                // Undo downvote
                                downvotedBy = downvotedBy.filter(uid => uid !== currentUserId);
                                currentVotes++;
                            } else {
                                // Downvote
                                downvotedBy.push(currentUserId);
                                currentVotes--;
                                // If previously upvoted, undo upvote
                                if (isCurrentlyUpvoted) {
                                    upvotedBy = upvotedBy.filter(uid => uid !== currentUserId);
                                    currentVotes--; // Compensate for the upvote removal
                                }
                            }
                        }

                        // Update Firestore
                        await updateDoc(postRef, {
                            votes: currentVotes,
                            upvotedBy: upvotedBy,
                            downvotedBy: downvotedBy
                        });

                        // Update UI
                        voteCountSpan.textContent = currentVotes;
                        upvoteButton.classList.toggle('active', upvotedBy.includes(currentUserId));
                        downvoteButton.classList.toggle('active', downvotedBy.includes(currentUserId));

                    } else {
                        console.warn("Post not found:", postId);
                    }
                } catch (error) {
                    console.error("Error updating vote:", error);
                    alert('Gagal melakukan vote. Coba lagi.');
                }
            }


            // Highlighting the active link in sidebar and bottom nav
            const path = window.location.pathname.split('/').pop();
            document.querySelectorAll('.sidebar-nav a, .bottom-nav .nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === path) {
                    link.classList.add('active');
                } else if (path === '' && link.getAttribute('href') === 'dashboard.html') {
                    link.classList.add('active');
                }
            });
        });

        // Logout function
        async function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                try {
                    await signOut(auth);
                    localStorage.removeItem('lastLoggedInUserId'); // Hapus UID dari localStorage
                    window.location.href = 'index.html'; // Redirect ke halaman login
                } catch (error) {
                    console.error("Error logging out:", error);
                    alert('Gagal logout. Coba lagi.');
                }
            }
        }

        // Dummy create post button (will be replaced by create-post.html)
        document.querySelector('.header-actions button:nth-child(2)').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'create-post.html'; // Arahkan ke halaman buat post
        });
    </script>
</body>
</html>
