<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifikasi - 9Gaul</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h2><i class="fas fa-laugh-squint"></i> 9Gaul</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="dashboard.html"><i class="fas fa-home"></i> Beranda</a></li>
                    <li><a href="explore.html"><i class="fas fa-compass"></i> Explore</a></li>
                    <li><a href="groups.html"><i class="fas fa-users"></i> Grup</a></li>
                    <li class="separator"></li>
                    <li><a href="service-center.html"><i class="fas fa-headset"></i> Service Center</a></li>
                    <li><a href="donate.html"><i class="fas fa-heart"></i> Donasi</a></li>
                </ul>
            </nav>
            <div class="sidebar-profile">
                <a href="profile.html"><img src="https://via.placeholder.com/40/8ab4f8/FFFFFF?text=P" alt="Profil Pengguna"></a>
                <div class="profile-info">
                    <a href="profile.html"><strong>Pengguna Dummy</strong></a>
                    <span class="user-email" id="loggedInEmailSidebar"></span>
                </div>
                <a href="#" class="logout-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button class="back-button-mobile" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
                <h1>Notifikasi</h1>
                <div class="header-actions">
                    <button class="active"><i class="fas fa-bell"></i></button>
                    <button class="create-post-btn" onclick="window.location.href='create-post.html'"><i class="fas fa-plus"></i></button>
                    <button class="profile-icon-mobile-header" onclick="window.location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
                </div>
            </header>

            <section class="notifications-container">
                <div class="notification-filters card-style">
                    <button class="filter-btn active" data-filter="all">Semua</button>
                    <button class="filter-btn" data-filter="likes">Suka</button>
                    <button class="filter-btn" data-filter="comments">Komentar</button>
                    <button class="filter-btn" data-filter="mentions">Mention</button>
                    <button class="filter-btn" data-filter="groups">Grup</button>
                </div>

                <div class="notifications-list" id="notificationsList">
                    <p class="no-notifications-message" style="display: none; text-align: center; color: var(--sub-text-color); padding: 20px;">Tidak ada notifikasi untuk kategori ini.</p>
                    <p id="loading-notifications" style="text-align: center; color: var(--sub-text-color); padding: 20px;">Memuat notifikasi...</p>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span class="nav-text">Beranda</span></a>
            <a href="explore.html" class="nav-item"><i class="fas fa-compass"></i><span class="nav-text">Explore</span></a>
            <a href="groups.html" class="nav-item"><i class="fas fa-users"></i><span class="nav-text">Grup</span></a>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script>
        // Your Firebase configuration goes here
        // IMPORTANT: Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variable to store notifications fetched from Firestore
        let allNotifications = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const loggedInEmail = localStorage.getItem('lastRegisteredDummyEmail');
            if (loggedInEmail) {
                const loggedInEmailSidebar = document.getElementById('loggedInEmailSidebar');
                if (loggedInEmailSidebar) {
                    loggedInEmailSidebar.textContent = loggedInEmail;
                }
            } else {
                console.warn("Tidak ada email yang ditemukan, mungkin pengguna belum login. Mengarahkan kembali ke halaman login.");
                window.location.href = 'index.html';
                return; // Stop execution if not logged in
            }

            // Highlighting the active link
            const path = window.location.pathname.split('/').pop();
            document.querySelectorAll('.sidebar-nav a, .bottom-nav .nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === path) {
                    link.classList.add('active');
                }
            });
            // Specific highlight for notification icon in header
            const notificationButton = document.querySelector('.header-actions button.active');
            if (notificationButton && path === 'notifications.html') {
                notificationButton.classList.add('active');
            }

            const notificationsList = document.getElementById('notificationsList');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const noNotificationsMessage = document.querySelector('.no-notifications-message');
            const loadingNotifications = document.getElementById('loading-notifications');

            // --- Function to fetch notifications from Firebase Firestore ---
            async function fetchNotifications() {
                loadingNotifications.style.display = 'block';
                noNotificationsMessage.style.display = 'none';
                notificationsList.innerHTML = ''; // Clear existing content except loading message

                // Get current user's UID (assuming user is authenticated)
                const user = auth.currentUser;
                if (!user) {
                    console.error("No user logged in. Cannot fetch notifications.");
                    loadingNotifications.textContent = "Gagal memuat notifikasi: Pengguna tidak login.";
                    return;
                }

                try {
                    // Fetch notifications for the current user
                    // In a real application, you'd likely have a 'notifications' collection
                    // where each document corresponds to a user's notification,
                    // or a subcollection under a user's document.
                    // For this example, let's assume a 'notifications' collection
                    // with a 'userId' field to filter by.
                    const notificationsRef = db.collection('notifications').where('userId', '==', user.uid).orderBy('timestamp', 'desc');
                    const snapshot = await notificationsRef.get();

                    allNotifications = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    loadingNotifications.style.display = 'none';
                    renderNotifications('all'); // Initial render after fetching
                } catch (error) {
                    console.error("Error fetching notifications:", error);
                    loadingNotifications.textContent = "Gagal memuat notifikasi: " + error.message;
                    noNotificationsMessage.style.display = 'block';
                }
            }

            // --- Function to render notifications based on filter ---
            function renderNotifications(filter = 'all') {
                notificationsList.innerHTML = ''; // Clear current notifications
                const filteredNotifications = allNotifications.filter(notif => {
                    if (filter === 'all') return true;
                    if (filter === 'likes' && notif.type === 'like') return true;
                    if (filter === 'comments' && notif.type === 'comment') return true;
                    if (filter === 'mentions' && notif.type === 'mention') return true;
                    if (filter === 'groups' && notif.type === 'group_invite') return true;
                    return false;
                });

                if (filteredNotifications.length === 0) {
                    noNotificationsMessage.style.display = 'block';
                } else {
                    noNotificationsMessage.style.display = 'none';
                    filteredNotifications.forEach(notif => {
                        const notificationItem = document.createElement('div');
                        notificationItem.classList.add('notification-item');
                        if (!notif.read) {
                            notificationItem.classList.add('unread');
                        }
                        notificationItem.setAttribute('data-id', notif.id);
                        notificationItem.setAttribute('data-type', notif.type);

                        // Determine content based on notification type for dynamic messages
                        let notificationMessage = '';
                        let iconClass = '';
                        let iconColor = '';
                        let userAvatarUrl = notif.userAvatar || 'https://via.placeholder.com/40/CCCCCC/FFFFFF?text=U'; // Default avatar

                        switch (notif.type) {
                            case 'like':
                                notificationMessage = `<strong>${notif.userName}</strong> menyukai postingan Anda: "${notif.postSnippet || 'Tidak ada pratinjau'}"`;
                                iconClass = 'fas fa-heart';
                                iconColor = 'var(--button-danger-bg)';
                                break;
                            case 'comment':
                                notificationMessage = `<strong>${notif.userName}</strong> mengomentari postingan Anda: "${notif.commentSnippet || 'Tidak ada pratinjau'}"`;
                                iconClass = 'fas fa-comment';
                                iconColor = 'var(--accent-color)';
                                break;
                            case 'mention':
                                notificationMessage = `<strong>${notif.userName}</strong> menyebut Anda di postingannya: "Lihat ini <span style="color: var(--link-color);">@PenggunaDummy</span>, ini menarik!"`;
                                iconClass = 'fas fa-at';
                                iconColor = 'var(--action-button-bg)';
                                break;
                            case 'group_invite':
                                notificationMessage = `Anda diundang ke grup <strong>"${notif.groupName}"</strong>.`;
                                iconClass = 'fas fa-users';
                                iconColor = 'var(--link-color)';
                                userAvatarUrl = 'https://via.placeholder.com/40/32CD32/FFFFFF?text=G'; // Generic group invite avatar
                                break;
                            case 'system':
                                notificationMessage = `<strong>Sistem 9Gaul</strong>: ${notif.message}`;
                                iconClass = 'fas fa-info-circle';
                                iconColor = 'var(--text-color)';
                                userAvatarUrl = 'https://via.placeholder.com/40/8A2BE2/FFFFFF?text=S'; // Generic system avatar
                                break;
                            default:
                                notificationMessage = notif.message || 'Notifikasi baru.';
                                iconClass = 'fas fa-bell';
                                iconColor = 'var(--text-color)';
                        }

                        // Format timestamp to a more readable "X minutes ago"
                        const timeAgo = formatTimeAgo(notif.timestamp ? notif.timestamp.toDate() : new Date());


                        notificationItem.innerHTML = `
                            <img src="${userAvatarUrl}" alt="User Avatar" class="notification-avatar">
                            <div class="notification-content">
                                <p>${notificationMessage}</p>
                                <span class="notification-time"><i class="far fa-clock"></i> ${timeAgo}</span>
                            </div>
                            <i class="notification-icon ${iconClass}" style="color: ${iconColor};"></i>
                        `;
                        notificationsList.appendChild(notificationItem);
                    });
                }
            }

            // Function to format time difference
            function formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);

                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " tahun yang lalu";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " bulan yang lalu";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " hari yang lalu";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " jam yang lalu";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " menit yang lalu";
                return Math.floor(seconds) + " detik yang lalu";
            }

            // Initial fetch and render
            fetchNotifications();

            // Filter button click handler
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderNotifications(button.dataset.filter);
                });
            });

            // Mark as read when clicked and update in Firestore
            notificationsList.addEventListener('click', async (event) => {
                const item = event.target.closest('.notification-item');
                if (item && item.classList.contains('unread')) {
                    item.classList.remove('unread');
                    const notifId = item.dataset.id;
                    try {
                        await db.collection('notifications').doc(notifId).update({ read: true });
                        console.log(`Notification ${notifId} marked as read in Firestore.`);
                        // Update the local allNotifications array as well
                        const notifIndex = allNotifications.findIndex(n => n.id === notifId);
                        if (notifIndex !== -1) {
                            allNotifications[notifIndex].read = true;
                        }
                    } catch (error) {
                        console.error("Error marking notification as read:", error);
                        // If error, you might want to revert the UI change or inform the user
                        item.classList.add('unread');
                    }
                }
            });
        });

        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                auth.signOut().then(() => {
                    localStorage.removeItem('lastRegisteredDummyEmail');
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error("Error logging out:", error);
                    alert("Terjadi kesalahan saat logout. Silakan coba lagi.");
                });
            }
        }
    </script>
</body>
</html>
